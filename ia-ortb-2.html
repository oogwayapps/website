<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ad Renderer</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #f0f0f0;
      }

      #gg-ad-renderer {
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(
          90deg,
          rgba(200, 200, 200, 0.5),
          rgba(220, 220, 220, 0.5)
        );
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        overflow: hidden;
        position: absolute;
      }

      iframe {
        border: none;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="gg-ad-renderer"></div>
    <script>
      class AdRenderer {
        constructor() {
          this.vuplexReady = false;
          this.adRenderer = document.getElementById("gg-ad-renderer");
          this.initialize();
        }

        async initialize() {
          try {
            await this.waitForVuplex();
            await this.renderAd();
            this.setupLinkInterception();
          } catch (error) {
            console.error("Initialization error:", error);
          }
        }

        async waitForVuplex() {
          if (!window.vuplex) {
            await new Promise((resolve) => {
              window.addEventListener(
                "vuplexready",
                () => {
                  this.vuplexReady = true;
                  resolve();
                },
                { once: true }
              );
            });
          } else {
            this.vuplexReady = true;
          }
        }

        async getDimensionsFromUnity() {
          return new Promise((resolve) => {
            const handleMessage = (event) => {
              const data = JSON.parse(event.data);
              if (data.type === "GetDimensions" && data.dimension) {
                window.vuplex.removeEventListener("message", handleMessage);
                resolve({
                  width: Number(data.dimension.width),
                  height: Number(data.dimension.height),
                });
              }
            };

            window.vuplex.addEventListener("message", handleMessage);
            window.vuplex.postMessage({ type: "GetDimensions" });
          });
        }

        async getAdJsonFromUnity() {
          return new Promise((resolve) => {
            const handleMessage = (event) => {
              const data = JSON.parse(event.data);
              if (data.type === "GetDemandInfo" && data.demand) {
                window.vuplex.removeEventListener("message", handleMessage);
                resolve(data.demand);
              }
            };

            window.vuplex.addEventListener("message", handleMessage);
            window.vuplex.postMessage({ type: "GetDemandInfo" });
          });
        }

        async renderAd() {
          const { width: webViewWidth, height: webViewHeight } =
            await this.getDimensionsFromUnity();
          const demand = await this.getAdJsonFromUnity();
          const { w: adWidth, h: adHeight, adm: html } = demand;

          // New fitting logic to keep ad full width
          const scale = webViewWidth / adWidth;
          const scaledHeight = Math.floor(adHeight * scale);

          this.adRenderer.style.width = `${webViewWidth}px`;
          this.adRenderer.style.height = `${scaledHeight}px`;

          // Center vertically only
          this.adRenderer.style.left = "0";
          this.adRenderer.style.top = `${(webViewHeight - scaledHeight) / 2}px`;

          const iframe = document.createElement("iframe");
          iframe.scrolling = "no";
          iframe.srcdoc = html;
          this.adRenderer.appendChild(iframe);

          return iframe;
        }

        setupLinkInterception() {
          // Wait for iframe to load
          const iframe = this.adRenderer.querySelector("iframe");
          iframe.addEventListener("load", () => {
            const iframeWindow = iframe.contentWindow;
            const iframeDocument = iframe.contentDocument;
            console.log(iframeWindow, iframeDocument);
            // Intercept window.open
            iframeWindow.open = (url) => {
              this.handleNavigation(url);
              return null;
            };

            // Intercept anchor clicks
            iframeDocument.addEventListener(
              "click",
              (event) => {
                const anchor = event.target.closest("a[href]");
                if (anchor) {
                  event.preventDefault();
                  event.stopPropagation();
                  this.handleNavigation(anchor.href);
                }
              },
              true
            );

            // Override location methods
            // Object.defineProperty(iframeWindow.location, "href", {
            //   set: (url) => this.handleNavigation(url),
            // });
            // iframeWindow.location.assign = (url) => this.handleNavigation(url);
            // iframeWindow.location.replace = (url) => this.handleNavigation(url);
          });
        }

        handleNavigation(url) {
          if (this.vuplexReady) {
            window.vuplex.postMessage({ type: "OpenLink", url });
          }
        }
      }

      // Initialize when DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        console.log('Version: 1.1.0')
        new AdRenderer();
      });
    </script>
  </body>
</html>
