<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ad Renderer</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #f0f0f0;
      }

      #ad-renderer {
        position: absolute;
        background: linear-gradient(90deg, rgba(255, 0, 0, 0.5), rgba(0, 0, 255, 0.5));
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="ad-renderer"></div>
    <script>
      // Utility function to wait for Vuplex
      async function waitForVuplex() {
        if (!window.vuplex) {
          await new Promise((resolve) => {
            window.addEventListener("vuplexready", resolve, { once: true });
          });
        }
      }

      // Fetch dimensions from Unity
      async function fetchDimensions() {
        await waitForVuplex();
        return new Promise((resolve) => {
          const onMessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === "GetDimensions" && data.dimension) {
              console.log("[DEBUG] Dimensions received:", data.dimension);
              window.vuplex.removeEventListener("message", onMessage);
              resolve({
                width: Number(data.dimension.width),
                height: Number(data.dimension.height),
              });
            }
          };
          window.vuplex.addEventListener("message", onMessage);
          console.log("[DEBUG] Requesting dimensions from Unity...");
          window.vuplex.postMessage({ type: "GetDimensions" });
        });
      }

      // Fetch ad JSON from Unity
      async function fetchAdData() {
        await waitForVuplex();
        return new Promise((resolve) => {
          const onMessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === "GetDemandInfo" && data.demand) {
              console.log("[DEBUG] Ad data received:", data.demand);
              window.vuplex.removeEventListener("message", onMessage);
              resolve(data.demand);
            }
          };
          window.vuplex.addEventListener("message", onMessage);
          console.log("[DEBUG] Requesting ad data from Unity...");
          window.vuplex.postMessage({ type: "GetDemandInfo" });
        });
      }

      // Render ad inside iframe
      async function renderAd() {
        const { width: webViewWidth, height: webViewHeight } = await fetchDimensions();
        const adData = await fetchAdData();
        const { w: adWidth, h: adHeight, adm: adHtml } = adData;

        const adRenderer = document.getElementById("ad-renderer");
        const scale = Math.min(webViewWidth / adWidth, webViewHeight / adHeight, 1);
        const scaledWidth = Math.floor(adWidth * scale);
        const scaledHeight = Math.floor(adHeight * scale);

        Object.assign(adRenderer.style, {
          width: `${scaledWidth}px`,
          height: `${scaledHeight}px`,
          left: `${(webViewWidth - scaledWidth) / 2}px`,
          top: `${(webViewHeight - scaledHeight) / 2}px`,
        });

        const iframe = document.createElement("iframe");
        iframe.width = "100%";
        iframe.height = "100%";
        iframe.scrolling = "no";
        iframe.frameBorder = "0";
        iframe.srcdoc = adHtml;

        adRenderer.appendChild(iframe);
        setupClickRedirection(iframe);
      }

      // Setup click redirection for links in iframe
      function setupClickRedirection(iframe) {
        setTimeout(() => {
          const iframeDoc = iframe.contentDocument;
          const iframeWin = iframe.contentWindow;

          if (!iframeDoc || !iframeWin) {
            console.error("[DEBUG] Iframe document or window is missing.");
            return;
          }

          const redirectLink = (url) => {
            console.log("[DEBUG] Redirecting link to:", url);
            window.vuplex.postMessage({ type: "OpenLink", url });
          };

          // Intercept anchor tag clicks
          iframeDoc.addEventListener("click", (event) => {
            const link = event.target.closest("a[href]");
            if (link) {
              console.log("[DEBUG] Anchor tag clicked. Redirecting:", link.href);
              redirectLink(link.href);
              event.preventDefault();
            }
          });

          // Override `window.open`
          iframeWin.open = (url) => {
            console.log("[DEBUG] Window open intercepted. Redirecting:", url);
            redirectLink(url);
            return null;
          };

          // Override `location.assign` and `location.replace`
          const overrideLocation = (method, url) => {
            console.log(`[DEBUG] Location.${method} intercepted. Redirecting:`, url);
            redirectLink(url);
          };

          iframeWin.location.assign = (url) => overrideLocation("assign", url);
          iframeWin.location.replace = (url) => overrideLocation("replace", url);

          console.log("[DEBUG] Click redirection setup complete.");
        }, 3000); // Wait for iframe content to load
      }

      renderAd().catch((error) => {
        console.error("[ERROR] Error rendering ad:", error);
      });
    </script>
  </body>
</html>
