<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #f0f0f0;
      }

      #gg-ad-renderer {
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(
          90deg,
          rgba(255, 0, 0, 0.5),
          rgba(0, 0, 255, 0.5)
        );
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        overflow: hidden;
        position: absolute;
      }
    </style>
  </head>
  <body>
    <div id="gg-ad-renderer"></div>
    <script>
      console.log("Loaded version: 1.0.7");
      async function getDimensionsFromUnity() {
        // Ensure Vuplex is ready
        if (!window.vuplex) {
          await new Promise((resolve) => {
            window.addEventListener("vuplexready", resolve, { once: true });
          });
        }

        return new Promise((resolve) => {
          function handleMessage(event) {
            console.log("Message received from Unity:", event.data);
            const data = JSON.parse(event.data);

            if (data.width && data.height) {
              window.vuplex.removeEventListener("message", handleMessage);
              resolve({
                width: Number(data.width),
                height: Number(data.height),
              });
            }
          }

          window.vuplex.addEventListener("message", handleMessage);
          console.log("Sending message to Unity: GetDimensions");
          window.vuplex.postMessage("GetDimensions");
        });
      }

      async function renderAddToIframe() {
        const { width: webViewWidth, height: webViewHeight } =
          await getDimensionsFromUnity();
        console.log(
          "WebView Dimensions - Width:",
          webViewWidth,
          "Height:",
          webViewHeight
        );

        const res = await fetch(
          "https://run.mocky.io/v3/6706ce00-4e71-46e4-87f8-f30c5e60403c"
        );
        // const res = await fetch("https://run.mocky.io/v3/53570b47-35fa-4fed-8faf-da7710dd0456");
        const data = await res.json();
        const adWidth = data.seatbid[0].bid[0].w || 1280; // Ad width from the mock server
        const adHeight = data.seatbid[0].bid[0].h || 800; // Ad height from the mock server
        const html = data.seatbid[0].bid[0].adm;

        const adRenderer = document.getElementById("gg-ad-renderer");

        // Scale ad to fit within the WebView if necessary
        let scaledWidth = adWidth;
        let scaledHeight = adHeight;

        if (adWidth > webViewWidth || adHeight > webViewHeight) {
          const widthRatio = webViewWidth / adWidth;
          const heightRatio = webViewHeight / adHeight;
          const scale = Math.min(widthRatio, heightRatio);

          scaledWidth = Math.floor(adWidth * scale);
          scaledHeight = Math.floor(adHeight * scale);
        }

        adRenderer.style.width = `${scaledWidth}px`;
        adRenderer.style.height = `${scaledHeight}px`;

        // Center the ad within the WebView
        adRenderer.style.left = `${(webViewWidth - scaledWidth) / 2}px`;
        adRenderer.style.top = `${(webViewHeight - scaledHeight) / 2}px`;

        const iframe = document.createElement("iframe");
        iframe.width = "100%";
        iframe.height = "100%";
        iframe.scrolling = "no";
        iframe.frameBorder = "0";
        iframe.srcdoc = html;

        adRenderer.appendChild(iframe);
      }

      setTimeout(() => {
        renderAddToIframe();
      }, 3000);
    </script>
    <script>
      console.log(window);
      setInterval(() => {
        // Detect <a> tags that don't have our custom 'overridden' attribute
        // and update them to add the 'overridden' attribute and send the link
        // URL to the app's C# via window.vuplex.postMessage() when the link is clicked.
        const newLinks = document.querySelectorAll("a[href]:not([overridden])");
        console.log("Found new links:", newLinks);
        for (const link of newLinks) {
          link.setAttribute("overridden", true);
          const linkUrl = link.href;
          link.addEventListener("click", (event) => {
            // Send the link URL to the C# script.
            console.log(
              "Sending message to Unity: OpenLink",
              linkUrl,
              link,
              link?.contentWindow
            );
            window.vuplex &&
              window.vuplex.postMessage({ type: "OpenLink", url: linkUrl });
            // Call preventDefault() to prevent the webview from loading the URL.
            event.preventDefault();
          });
        }
      }, 250);
    </script>
  </body>
</html>
